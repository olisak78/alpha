# Developer Portal Backend

A robust Go backend server for a developer portal, built with modern best practices and clean architecture.

## TL;DR — Quick Start

```bash
# 1) Clone and setup
git clone https://github.tools.sap/cfs-platform-engineering/developer-portal-backend.git
cd developer-portal-backend
make setup   # installs deps, starts Postgres, installs migrate tool, generates .env from Vault

# 2) Start server (requires .env generated by make setup or make generate-env)
make run-dev
```

Server runs at: http://localhost:7008
---

## Architecture

This repository follows a layered design with clear separation of concerns.

```
developer-portal-backend/
├── cmd/
│   └── server/                 # Application entry point (main.go)
├── internal/
│   ├── api/
│   │   ├── handlers/           # HTTP handlers (controllers)
│   │   ├── middleware/         # Custom middleware (logging, recovery, CORS, request ID)
│   │   └── routes/             # Route definitions and wiring
│   ├── auth/                   # OAuth (GitHub Enterprise), JWT, refresh-token flow
│   ├── cache/                  # In-memory cache and TTL config
│   ├── client/                 # External service clients (alert storage)
│   ├── config/                 # Application config via viper (env + config.yaml)
│   ├── constants/              # Shared constants
│   ├── database/
│   │   ├── models/             # GORM models/entities
│   │   ├── data_utils.go       # Helpers for YAML data loading
│   │   ├── database.go         # DB init, automigrate, indexes, seed
│   │   └── init_data.go        # Data import from scripts/data/*.yaml
│   ├── logger/                 # Log setup utilities
│   ├── repository/             # Data access layer (CRUD and queries)
│   ├── service/                # Business logic layer
│   └── testutils/              # Testing utilities
├── config/
│   └── auth.yaml               # Auth providers & redirect URL (env-driven)
├── docker/
│   ├── docker-compose.yml      # Local Postgres, optional pgAdmin/Redis
│   ├── docker-compose.test.yml # Test DB and runner container
│   └── Dockerfile              # Backend image
├── docs/                       # Swagger/OpenAPI generated files
├── charts/                     # Helm chart & deploy script
├── env/                        # Env management (template, generate/validate scripts)
├── scripts/                    # Development/data scripts
├── Makefile                    # Development, testing, build, deploy
└── README.md
```

---

## Setup & Running

### Option 1: Quick Development Setup (Recommended)

```bash
# Complete setup: deps, migrate tool, Postgres, optional migrations, .env generation
make setup
```
```bash
# Start development server
make run-dev
```

Server will start on `http://localhost:7008`. Swagger UI at `http://localhost:7008/swagger/index.html`.

### Option 2: Manual Setup

```bash
# 1) Install dependencies
make deps

# 2) Start database (Postgres on localhost:5432)
make db-up

# 3) Generate environment (.env) from Vault
make generate-env

# 4) (Optional) Run migrations if you have any migration files
make migrate-up

# 5) Start the server
make run-dev
```

---

### Environment Management

See [README.md](env/README.md) for full details.

---

## Database Management

```bash
# Start only PostgreSQL
make db-up

# Reset database (WARNING: deletes all data)
make db-reset

# Stop database
make db-down
```

Local services (docker-compose):
- Postgres 17 (mapped to `localhost:5432`)
- Optional pgAdmin on `http://localhost:5050` (default admin/admin)
- Optional Redis on `localhost:6379`

Initial data:
- Loaded automatically from `scripts/data/*.yaml` at server startup:
  - organizations, groups, teams, users, projects, landscapes, components, categories, links, plugins

---

## Authentication

OAuth with GitHub Enterprise providers and JWT-based auth for API calls.

Providers:
- `githubtools` — https://github.tools.sap
- `githubwdf` — https://github.wdf.sap.corp

Flow:
- Start login: `GET /api/auth/{provider}/start`
- Callback frame: `GET /api/auth/{provider}/handler/frame`
- Refresh JWT: `GET /api/auth/refresh` returns `{ "accessToken": "<jwt>" }`
- Logout: `POST /api/auth/logout`

- All `/api/v1/**` endpoints require a valid `Authorization: Bearer <jwt>` header and will enforce `RequireAuth()` middleware.

See detailed module docs: [README.md](internal/auth/README.md).

---

## API Documentation

Swagger / OpenAPI is generated and served by the backend.

- Start server: `make run-dev` or `go run cmd/server/main.go`
- Open UI: `http://localhost:7008/swagger/index.html`
- Base path: `/api/v1`
- Authentication: endpoints under `/api/v1` require a valid JWT

Regenerate documentation after changing handler annotations:

```bash
# One-time install
brew install swag
```

```bash
# Regenerate
swag init -g cmd/server/main.go
```

Generates/updates:
- `docs/docs.go`, `docs/swagger.json`, `docs/swagger.yaml`

---

## Development Commands

```bash
# Show all available commands
make help

# Development workflow
make format           # go fmt + goimports
make lint             # golangci-lint
make build            # build application
make clean-build      # clean build artifacts


---

## Testing

Quick testing:
```
make test            # runs tests and generates JUnit XML report
make test-coverage   # coverage report (coverage.html)
```

Additional targets:
```
make test-unit         # unit tests only
make test-precommit    # format, lint, unit tests
make test-setup        # start test DB
make test-all          # unit + integration
make test-coverage-full
make test-race
make test-teardown     # stop test DB
make test-docker       # run tests inside Docker
make mocks             # generate gomock mocks
```

CI pipeline example:
```
make test-ci          # coverage + race detection
```

---

## Data Flow

```
HTTP Request → Auth Middleware → Handler → Service → Repository → Database
                     ↓             ↓         ↓          ↓
HTTP Response ← Auth Middleware ← Handler ← Service ← Repository ← Database
```

---

## Security Considerations

- JWT auth for protected endpoints (`/api/v1/**`)
- Refresh-token cookie (HttpOnly, Secure, SameSite=Lax) for token refresh
- Secrets managed via Vault and `.env` (never commit secrets)
- CORS configured via `ALLOWED_ORIGINS`
- Input validation via `go-playground/validator`
- GORM helps mitigate SQL injection by parameterization

Production checklist:
- Configure GitHub OAuth apps (client IDs and secrets)
- Restrict `ALLOWED_ORIGINS` to production domains
- Enforce HTTPS and secure cookies
- Secure DB credentials and rotate secrets periodically
- Enable request logging and monitoring

---

## Deployment

Makefile supports a versioned build/push and Helm deployment flow.

Recommended workflow:
```
# Set the new version (e.g., 1.0.8). This updates charts/developer-portal-backend/values.yaml image tag.
make docker-build TAG=1.0.8

# Push image (also creates/pushes git tag backend-<TAG> if not existing)
make docker-push TAG=1.0.8

# (Optional) Update values.yaml explicitly
make update-values TAG=1.0.8

# Verify cluster, ensure TAG matches values.yaml, then deploy to dev
make deploy-dev TAG=1.0.8

# Deploy to prod (after validation)
make deploy-prod TAG=1.0.8
```

One-shot release:
```
make release TAG=1.0.8  # build+push, update values.yaml, deploy to dev
```

Manual Helm deployment:
```bash
cd charts/developer-portal-backend
./deploy.sh dev   # or prod
```

Deploy script responsibilities:
- Validates required env variables
- Maps environment-specific GitHub OAuth credentials
- Configures ingress hosts
- Runs Helm with appropriate values

---

## Ports

- Backend: `7008`
- Postgres: `5432` (Docker)
- pgAdmin: `5050` (optional)
- Redis: `6379` (optional)

---

## Troubleshooting

Database connection failed:
```bash
make db-up
docker-compose -f docker/docker-compose.yml logs postgres
```

Authentication issues:
- Check GitHub OAuth config (client IDs/secrets)
- Ensure `config/auth.yaml` resolves provider config via env vars
- Confirm `redirect_url` matches server base URL (`http://localhost:7008`)

Port already in use:
```bash
# Change port in .env (PORT=8080) or kill the process:
lsof -ti:7008 | xargs kill
```

Migration errors:
```bash
ls internal/database/migrations/         # only if you use manual migrations
make migrate-force VERSION=1
```

Environment validation failed:
- Run `make generate-env`
- Verify Vault login via `vault login -method=oidc`

---

## License

Project licensing is intended to be MIT. Refer to the repository’s `LICENSE` file if present.

---

## Support

- Open an issue in the repository
- Review this README and module-specific docs:
  - `internal/auth/README.md`
  - `env/README.md`
- Consult the troubleshooting section

---

Happy Coding!
